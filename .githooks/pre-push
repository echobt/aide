#!/bin/bash
set -e

# Skip hooks if SKIP_GIT_HOOKS is set
if [ "${SKIP_GIT_HOOKS:-0}" = "1" ]; then
  echo "â­ï¸  Skipping pre-push hook (SKIP_GIT_HOOKS=1)"
  exit 0
fi

echo "ğŸš€ Running pre-push quality gate..."

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1. Rust formatting
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if command -v cargo >/dev/null 2>&1; then
  echo "  â–¸ [1/6] Checking Rust formatting..."
  (cd src-tauri && cargo +nightly fmt --all -- --check 2>/dev/null) || {
    echo "âŒ Rust formatting failed. Run: cd src-tauri && cargo +nightly fmt --all"
    exit 1
  }
  echo "  âœ… Rust formatting OK"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 2. Rust linting (clippy)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  echo "  â–¸ [2/6] Running Clippy..."
  (cd src-tauri && cargo +nightly clippy --all-targets --all-features -- -D warnings 2>/dev/null) || {
    echo "âŒ Clippy found warnings/errors. Fix them before pushing."
    exit 1
  }
  echo "  âœ… Clippy OK"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 3. Rust type check
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  echo "  â–¸ [3/6] Checking Rust compilation..."
  (cd src-tauri && cargo +nightly check 2>/dev/null) || {
    echo "âŒ Rust compilation check failed."
    exit 1
  }
  echo "  âœ… Rust compilation OK"
else
  echo "  âš ï¸  cargo not found, skipping Rust checks (steps 1-3)"
fi

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 4. TypeScript type check
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if command -v npx >/dev/null 2>&1 && [ -f "tsconfig.json" ]; then
  echo "  â–¸ [4/6] Checking TypeScript types..."
  npm run typecheck || {
    echo "âŒ TypeScript type check failed."
    exit 1
  }
  echo "  âœ… TypeScript types OK"
else
  echo "  âš ï¸  Skipping TypeScript check"
fi

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 5. Frontend tests
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if command -v npx >/dev/null 2>&1 && [ -f "package.json" ]; then
  echo "  â–¸ [5/6] Running frontend tests..."
  npm run test || {
    echo "âŒ Frontend tests failed."
    exit 1
  }
  echo "  âœ… Frontend tests OK"
else
  echo "  âš ï¸  Skipping frontend tests"
fi

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 6. Frontend build
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if command -v npx >/dev/null 2>&1 && [ -f "package.json" ]; then
  echo "  â–¸ [6/6] Building frontend..."
  npm run build || {
    echo "âŒ Frontend build failed."
    exit 1
  }
  echo "  âœ… Frontend build OK"
else
  echo "  âš ï¸  Skipping frontend build"
fi

echo "âœ… Pre-push quality gate passed! Pushing..."
